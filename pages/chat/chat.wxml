<view class="chat-page">
  <block wx:if="{{introMode}}">
    <view class="intro-layer">
      <image class="intro-bg" src="../../images/chat_bg.png" mode="aspectFill"></image>
      <view class="intro-container">
        <view class="intro-hero">
          <text class="hero-line">有些心意，</text>
          <text class="hero-line">不知道怎么表达。</text>
        </view>
        
        <view class="intro-center">
          <view class="prompt-line">
            <text class="prompt-text">Hi，{{userName ? userName : ''}} 有什么想聊聊吗？</text>
          </view>
          <view class="input-area">
            <view class="toggle-btn" bindtap="onToggleVoiceMode">
              <image class="toggle-img" src="{{voiceMode ? '../../images/text.png' : '../../images/voice.png'}}" mode="aspectFit"></image>
            </view>
            <block wx:if="{{!voiceMode}}">
              <input class="input" placeholder="{{introPlaceholder}}" placeholder-style="color:#b6b8bb" value="{{inputValue}}" bindinput="onIntroInput" confirm-type="send" bindconfirm="onIntroSend" />
            </block>
            <block wx:else>
              <view class="voice-input {{recording ? 'recording' : ''}}" bindtouchstart="onVoiceStart" bindtouchend="onVoiceEnd" bindtouchcancel="onVoiceCancel">
                <text class="voice-text">{{voiceHint}}</text>
              </view>
            </block>
            <view class="send-btn intro-send" bindtap="onIntroSend">
              <image class="send-img" src="../../images/send.png" mode="aspectFit"></image>
            </view>
          </view>
          <view class="quick-caps-out">
            <view class="cap" data-text="送闺蜜" bindtap="onQuickCapsule">送闺蜜</view>
            <view class="cap" data-text="送长辈" bindtap="onQuickCapsule">送长辈</view>
            <view class="cap" data-text="送爱人" bindtap="onQuickCapsule">送爱人</view>
            <view class="cap" data-text="送客户" bindtap="onQuickCapsule">送客户</view>
          </view>
        </view>
      </view>
    </view>
  </block>

  <view class="fixed-header" wx:if="{{!introMode}}">
    <view class="header">
      <view class="header-texts">
        <text class="greeting">{{greeting}}</text>
        <text class="subtext">{{welcomStr}}</text>
      </view>
      <view class="header-illustration">
        <image class="avatar-image" src="https://wumuxuan-1253516064.cos.ap-shanghai.myqcloud.com/ccg/uni-app/gift.png" mode="aspectFill"></image>
      </view>
    </view>
  </view>

  <scroll-view wx:if="{{!introMode}}" class="chat-scroll {{hasPills ? '' : 'no-pills'}}" scroll-y="true" scroll-with-animation="true" scroll-into-view="{{scrollInto}}">
    <view class="messages">
      <block wx:for="{{messages}}" wx:key="index">
        <block wx:if="{{item.type === 'cta'}}">
          <view class="cta-wrap">
            <button class="cta-btn" bindtap="onStartMatch">
              <text class="gift-icon">🎁</text>
              <text class="btn-text">开启礼物匹配 →</text>
            </button>
            <text class="cta-caption">已了解你的心意，准备好为您推荐</text>
          </view>
        </block>
        <block wx:elif="{{item.type === 'products'}}">
          <swiper class="prod-list" previous-margin="124rpx" next-margin="124rpx" circular="false" indicator-dots="false" duration="300" easing-function="easeInOutCubic" current="{{item.current || 0}}" data-mid="{{item._id}}" bindchange="onProdSwiperChange">
            <swiper-item wx:for="{{item.products}}" wx:key="index">
              <view class="prod-card {{(item.current || 0) === index ? 'selected' : ''}}" bindtap="selectProduct" data-index="{{index}}">
                <image class="band-bg" src="https://wumuxuan-1253516064.cos.ap-shanghai.myqcloud.com/ccg/uni-app/match_product_bg.png" mode="aspectFill"></image>
                <view class="header-band">
                  <view class="band-texts">
                    <text class="band-title">{{item.name}}</text>
                    <text class="band-sub">{{item.match_meaning || ''}}</text>
                  </view>
                </view>
                <view class="image-area">
                  <image class="card-image" src="{{item.img_url}}" mode="aspectFill"></image>
                  <view class="pill-btn overlay" data-index="{{index}}" bindtap="onOpenProduct">
                    <text>打开心意</text>
                  </view>
                </view>
              </view>
            </swiper-item>
          </swiper>
          <view class="light-actions">
            <button class="light-btn orange" bindtap="onGoMarketFromCards">去礼物甄选</button>
            <button class="light-btn gray" bindtap="onDislikeProducts">不感兴趣</button>
            <button class="light-btn outline" bindtap="onAnotherBatch">换一批</button>
          </view>
          <view id="prod-anchor-{{item._id}}" class="end-anchor"></view>
        </block>
        <block wx:else>
          <view id="msg-{{index}}" class="bubble {{item.role === 'user' ? 'right' : 'left'}}">
            <block wx:if="{{item.typing}}">
              <view class="typing">
                <view class="dot"></view>
                <view class="dot"></view>
                <view class="dot"></view>
              </view>
            </block>
            <block wx:else>
              <text>{{item.content}}</text>
            </block>
          </view>
        </block>
      </block>
      <view id="end-anchor" class="end-anchor"></view>
    </view>
  </scroll-view>

  <view wx:if="{{!introMode}}" class="fixed-footer {{hasPills ? '' : 'no-pills'}}">
    <view class="footer-bg"></view>
    <scroll-view class="history-scroll" scroll-x="true" show-scrollbar="false">
      <view class="secondary-actions history-pills">
        <view class="pill lite">
          <text class="pill-text lite">上次送给妈妈的礼物</text>
        </view>
        <view class="pill lite">
          <text class="pill-text lite">给客户的感谢表达</text>
        </view>
        <view class="pill lite">
          <text class="pill-text lite">道歉礼物方案</text>
        </view>
        <view class="pill lite" bindtap="onGiftHistory">
          <text class="pill-text lite">礼赠历史</text>
        </view>
      </view>
    </scroll-view>

    <view class="input-area">
      <view class="toggle-btn" bindtap="onToggleVoiceMode">
        <image class="toggle-img" src="{{voiceMode ? '../../images/text.png' : '../../images/voice.png'}}" mode="aspectFit"></image>
      </view>
      <block wx:if="{{!voiceMode}}">
        <input class="input" placeholder="请输入消息…" placeholder-style="color:#b6b8bb" value="{{inputValue}}" bindinput="onInput" confirm-type="send" bindconfirm="onSend" />
      </block>
      <block wx:else>
        <view class="voice-input {{recording ? 'recording' : ''}}" bindtouchstart="onVoiceStart" bindtouchend="onVoiceEnd" bindtouchcancel="onVoiceCancel">
          <text class="voice-text">{{voiceHint}}</text>
        </view>
      </block>
      <view class="send-btn" bindtap="onSend">
        <image class="send-img" src="../../images/send.png" mode="aspectFit"></image>
      </view>
    </view>
  </view>
</view>
