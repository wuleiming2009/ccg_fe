<view class="chat-page">
  <block wx:if="{{introMode}}">
    <view class="intro-layer">
      <view class="intro-container">
        <view class="intro-hero">
          <text class="hero-line">有些心意，</text>
          <text class="hero-line">不知道怎么表达。</text>
        </view>
        
        <view class="intro-center">
          <view class="prompt-line">
            <text class="prompt-text">Hi，{{userName ? userName : ''}} 有什么想聊聊吗？</text>
          </view>
          <view class="input-area">
            <view class="toggle-btn" bindtap="onToggleVoiceMode">
              <text class="toggle-icon">{{voiceMode ? 'T' : '🎤'}}</text>
            </view>
            <block wx:if="{{!voiceMode}}">
              <input class="input" placeholder="{{introPlaceholder}}" placeholder-style="color:#b6b8bb" value="{{inputValue}}" bindinput="onIntroInput" confirm-type="send" bindconfirm="onIntroSend" />
            </block>
            <block wx:else>
              <view class="voice-input {{recording ? 'recording' : ''}}" bindtouchstart="onVoiceStart" bindtouchend="onVoiceEnd" bindtouchcancel="onVoiceCancel">
                <text class="voice-text">{{voiceHint}}</text>
              </view>
            </block>
            <view class="send-btn intro-send" bindtap="onIntroSend">
              <text class="send-icon">➤</text>
            </view>
          </view>
          <view class="quick-caps-out">
            <view class="cap" data-text="送闺蜜" bindtap="onQuickCapsule">送闺蜜</view>
            <view class="cap" data-text="送长辈" bindtap="onQuickCapsule">送长辈</view>
            <view class="cap" data-text="送爱人" bindtap="onQuickCapsule">送爱人</view>
            <view class="cap" data-text="送客户" bindtap="onQuickCapsule">送客户</view>
          </view>
        </view>
      </view>
    </view>
  </block>

  <view class="fixed-header" wx:if="{{!introMode}}">
    <view class="header">
      <view class="header-texts">
        <text class="greeting">{{greeting}}</text>
        <text class="subtext">{{welcomStr}}</text>
      </view>
      <view class="header-illustration">
        <image class="avatar-image" src="https://wumuxuan-1253516064.cos.ap-shanghai.myqcloud.com/ccg/uni-app/gift.png" mode="aspectFill"></image>
      </view>
    </view>
  </view>

  <scroll-view wx:if="{{!introMode}}" class="chat-scroll {{hasPills ? '' : 'no-pills'}}" scroll-y="true" scroll-with-animation="true" scroll-into-view="{{scrollInto}}">
    <view class="messages">
      <block wx:for="{{messages}}" wx:key="index">
        <block wx:if="{{item.type === 'cta'}}">
          <view class="cta-wrap">
            <button class="cta-btn" bindtap="onStartMatch">
              <text class="gift-icon">🎁</text>
              <text class="btn-text">开启礼物匹配 →</text>
            </button>
            <text class="cta-caption">已了解你的心意，准备好为您推荐</text>
          </view>
        </block>
        <block wx:else>
          <view id="msg-{{index}}" class="bubble {{item.role === 'user' ? 'right' : 'left'}}">
            <block wx:if="{{item.typing}}">
              <view class="typing">
                <view class="dot"></view>
                <view class="dot"></view>
                <view class="dot"></view>
              </view>
            </block>
            <block wx:else>
              <text>{{item.content}}</text>
            </block>
          </view>
        </block>
      </block>
      <view id="end-anchor" class="end-anchor"></view>
    </view>
  </scroll-view>

  <view wx:if="{{!introMode}}" class="fixed-footer {{hasPills ? '' : 'no-pills'}}">
    <view class="footer-bg"></view>
    <view class="secondary-actions" wx:if="{{hasPills}}">
      <view class="pill blue" bindtap="onMyGifts" wx:if="{{showMyGifts}}">
        <text class="pill-icon">🎁</text>
        <text class="pill-text">我的礼赠</text>
      </view>
      <view class="pill orange" bindtap="onGiftHistory" wx:if="{{showGiftHistory}}">
        <text class="pill-icon">🕒</text>
        <text class="pill-text">礼赠历史</text>
      </view>
    </view>

    <view class="input-area">
      <view class="toggle-btn" bindtap="onToggleVoiceMode">
        <text class="toggle-icon">{{voiceMode ? 'T' : '🎤'}}</text>
      </view>
      <block wx:if="{{!voiceMode}}">
        <input class="input" placeholder="请输入消息…" placeholder-style="color:#b6b8bb" value="{{inputValue}}" bindinput="onInput" confirm-type="send" bindconfirm="onSend" />
      </block>
      <block wx:else>
        <view class="voice-input {{recording ? 'recording' : ''}}" bindtouchstart="onVoiceStart" bindtouchend="onVoiceEnd" bindtouchcancel="onVoiceCancel">
          <text class="voice-text">{{voiceHint}}</text>
        </view>
      </block>
      <view class="send-btn" bindtap="onSend">
        <text class="send-icon">➤</text>
      </view>
    </view>
  </view>
</view>
